name: autotag

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v6
        with:
          debug: true
          script: |
            const today = new Date();

            const prefix = [
              today.getUTCFullYear().toString(),
              (today.getUTCMonth() + 1).toString().padStart(2, '0'),
              today.getUTCDate().toString().padStart(2, '0'),
            ].join('.') + '.';

            core.info(`Tag prefix: ${prefix}`);

            const lastComponent = 0;

            for await (const response of github.paginate.iterator(github.rest.repos.listTags, context.repo)) {
              for (const tag of response.data) {
                if (!tag.name.startsWith(prefix))
                  continue;

                try {
                  const components = tag.name.split('.', 4);
                  const n = parseInt(components[3], 10);

                  if (n >= lastComponent)
                    lastComponent = n + 1;

                } catch (err) {
                  core.warning(`Can't parse tag ${tag}: ${err}`);
                }
              }
            }

            const ref = `refs/tags/${prefix}${lastComponent}`;
            const sha = context.sha;

            core.info(`Tagging ${sha} as ${ref}`);

            await github.rest.git.createRef({
              ...context.repo,
              ref,
              sha,
            });
